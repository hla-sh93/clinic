# مدير العيادة — العمليات والصلاحيات (Manager Role – Operations & Permissions)

## نظام إدارة عيادة الأسنان (Dental Clinic Management System)

**الدور:** MANAGER (مدير العيادة)  
**النطاق:** العيادة كاملة (عيادة واحدة فقط)  
**اللغة:** عربي فقط (RTL)  
**الموقع/المنطقة:** دمشق — سوريا  
**العملة:** ل.س (SYP) فقط  
**مبدأ عام:** أي عملية غير مذكورة صراحةً هنا تعتبر **ممنوعة**.

---

## 1) مبادئ غير قابلة للتفاوض

1. **لا يوجد حذف نهائي (Hard Delete) لأي شيء**  
   كل السجلات تبقى محفوظة، وأقصى ما يمكن هو:

   - تعطيل `is_active = false`
   - إلغاء/تفريغ مالي عبر “Void/Reversal” حسب قواعد المالية

2. **سجلات المال غير قابلة للتعديل بعد إنشائها**

   - الفواتير/الدفعات/المصروفات: لا تعديل، لا حذف
   - التصحيح يتم عبر آليات **Void / Reversal** فقط (إن كانت معتمدة في النظام)

3. **كل العمليات الحسّاسة تُسجَّل في Audit Log**  
   على الأقل:

   - تغييرات الحالات (Appointments/Invoices)
   - أي تغيير سعر/خصم
   - أي دفعة
   - أي حركة مخزون
   - إدارة المستخدمين والصلاحيات

4. **RBAC يُطبَّق سيرفرياً**  
   إخفاء أزرار في الواجهة لا يكفي.

---

## 2) صلاحيات عامة للمدير

المدير هو “مالك النظام” داخل العيادة، وله صلاحيات تشغيلية ومالية وإدارية كاملة، مع الالتزام بقواعد عدم الحذف وعدم تعديل السجلات المالية.

**المدير يستطيع:**

- الوصول لكل الوحدات (Modules)
- تنفيذ/اعتماد العمليات التشغيلية الحساسة
- رؤية كل البيانات على مستوى العيادة
- إدارة المستخدمين (إنشاء/تفعيل/تعطيل/تغيير كلمات مرور)
- إدارة التسعير (الخدمات) ضمن القيود
- إدارة المخزون وحركاته
- إدارة التقارير والتصدير
- قراءة كامل سجل التدقيق Audit Logs

---

## 3) إدارة المستخدمين والصلاحيات (Users & Roles)

### 3.1 عمليات مسموحة

- عرض قائمة المستخدمين (نشط/غير نشط)
- إنشاء مستخدم جديد:
  - الاسم الكامل
  - بيانات الدخول (حسب النظام)
  - اختيار الدور: **MANAGER** أو **DENTIST**
- تعديل بيانات المستخدم (غير الحساسة)
- تفعيل/تعطيل المستخدم
- إعادة تعيين كلمة المرور / فرض تغيير كلمة المرور عند الدخول
- ضبط إعدادات “نسبة أرباح الطبيب” إن كانت ضمن النظام المالي المعتمد (مع القيود)

### 3.2 قواعد وقيود

- **لا يمكن تعطيل طبيب لديه مواعيد مستقبلية** (قاعدة سلامة تشغيلية)
- كل عملية على المستخدمين يجب أن تُسجّل في Audit Log:
  - USER_CREATE / USER_UPDATE / USER_DEACTIVATE / PASSWORD_RESET / ROLE_ASSIGN
- لا يجوز إنشاء أدوار جديدة في هذه النسخة إلا بتعديل رسمي للـ SSOT

---

## 4) إدارة المرضى (Patients)

### 4.1 عمليات مسموحة

- إنشاء ملف مريض
- تعديل بيانات المريض (الاسم/الهاتف/ملاحظات عامة…)
- عرض ملف أي مريض
- عرض تاريخ الزيارات والتقارير المتعلقة بالمريض
- تعطيل/إعادة تفعيل المريض (يعني منع مواعيد جديدة فقط)
- إدارة مرفقات المريض (رفع/عرض/حذف منطقي)

### 4.2 قواعد وقيود

- **لا حذف نهائي للمرضى**
- تعطيل المريض:
  - يمنع إنشاء مواعيد جديدة
  - لا يؤثر على التاريخ
- أي تعديل بيانات حسّاس يُسجّل في Audit Log

---

## 5) إدارة الخدمات/الحالات الطبية (Medical Cases / Services)

### 5.1 عمليات مسموحة

- إنشاء خدمة/حالة طبية جديدة
- تعديل اسم الخدمة/وصفها
- تعديل السعر الأساسي (Base Price) ضمن القيود
- تفعيل/تعطيل الخدمة

### 5.2 قواعد وقيود (مهم)

- اسم الخدمة **فريد** (Unique)
- تغيير السعر لا يغيّر التاريخ:
  - السعر يُؤخذ Snapshot عند الموعد/الزيارة حسب قواعد المرحلة 1
- لا يمكن تعطيل خدمة مستخدمة إن كانت القاعدة تمنع ذلك (حسب تصميمكم):
  - إن تم منع التعطيل عند الاستخدام: النظام يرفض
  - أو يسمح بالتعطيل دون حذف تاريخي: الخدمة تُخفى من إنشاء مواعيد جديدة فقط

---

## 6) المواعيد والجدولة (Appointments & Scheduling)

> **قاعدة تم اعتمادها نهائياً:**  
> **الطبيب هو صاحب قرار تغيير حالة الموعد** (وصل/انتهى/أُلغي/No-show…)، لأنه مرتبط بالزيارة والملاحظات السريرية.  
> **المدير لا يلغي صلاحية الطبيب، لكنه يملك صلاحيات إشرافية كاملة** عند الحاجة.

### 6.1 عمليات مسموحة للمدير

- عرض كل المواعيد لكل الأطباء
- إنشاء موعد لأي طبيب/أي مريض
- تعديل موعد (الوقت/الخدمة/المريض/الطبيب) مع الالتزام بمنع التداخل
- تغيير حالة الموعد (صلاحية إشرافية):
  - CONFIRMED / COMPLETED / CANCELLED / NO_SHOW  
    _(لكن الأصل أن الطبيب هو من يغيّر الحالة عملياً — المدير يتدخل فقط عند الحاجة التشغيلية)_
- إضافة/تعديل ملاحظات إدارية على الموعد إن كانت موجودة

### 6.2 قواعد الجدولة

- لا تداخل مواعيد للطبيب نفسه:
  - `end_time <= next.start_time` مسموح
  - `end_time > next.start_time` مرفوض
- أقل مدة موعد: 15 دقيقة
- كل التواريخ/الأوقات تُخزَّن UTC وتُعرض بتوقيت العيادة

### 6.3 قواعد الحالات (Status)

- التغيير يجب أن يُسجّل في Audit Log:
  - APPOINTMENT_STATUS_CHANGE
- إلغاء الموعد/No-show يجب أن يتطلب “سبب” (Reason) إذا قررتوه كقاعدة حماية (مستحسن)

---

## 7) الزيارات السريرية (Visits / Clinical Record)

### 7.1 عمليات مسموحة للمدير

- عرض كل الزيارات
- عرض تفاصيل أي زيارة
- (حسب قواعد النظام) المدير هو الوحيد الذي يمكنه:
  - اعتماد/تعديل الخصم
  - اعتماد السعر النهائي (Final Price) قبل تثبيته
  - إدخال سبب أي تعديل سعري وإجباره

### 7.2 قواعد وقيود

- الزيارة تُنشأ فقط بعد أن يصبح الموعد **COMPLETED**
- بعد حفظ `final_price_syp` تصبح الزيارة **غير قابلة للتعديل المالي**
- أي تغيير سعري/خصم قبل الإقفال يجب أن يكون:
  - مبرر (Reason) إلزامي
  - مسجّل في Audit Log

---

## 8) الفواتير (Invoices)

### 8.1 عمليات مسموحة للمدير

- عرض جميع الفواتير
- عرض تفاصيل الفاتورة (المبلغ الكلي/المدفوع/المتبقي/الحالة)
- (إن كان النظام يدعم) تنفيذ VOID للفاتورة ضمن سياسة واضحة

### 8.2 قواعد وقيود

- الفاتورة تُنشأ تلقائياً من الزيارة (لا إنشاء يدوي)
- لا تعديل لمبلغ الفاتورة الكلي بعد الإنشاء
- حالة الفاتورة System-Controlled بناء على الدفعات:
  - UNPAID / PARTIALLY_PAID / PAID
- لا Refund (حسب قرارك):
  - أي “تراجع” مالي (إن وجد) يجب أن يكون عبر Void/Reversal فقط، وليس Refund

---

## 9) الدفعات (Payments) — كاش + تقسيط

> **قرار نهائي:** لا Refund  
> الدفع:

- **كاش**
- **تقسيط عبر دفعات** (installments)  
  المستخدم يُدخل مبلغ الدفعة، والنظام يحسب الباقي تلقائياً.

### 9.1 عمليات مسموحة للمدير

- إنشاء دفعة لفاتورة
- تسجيل عدة دفعات لنفس الفاتورة حتى الإغلاق
- عرض كل الدفعات
- عرض المتبقي لكل فاتورة
- (اختياري حسب سياسة النظام) تصحيح “دفعة خاطئة” عبر Void/Reversal إذا كانت معتمدة

### 9.2 قواعد وقيود

- لا يمكن دفع أكثر من المتبقي (Overpayment ممنوع)
- الدفعة دائماً `amount > 0`
- تاريخ الدفعة لا يمكن أن يكون بالمستقبل (مستحسن كقاعدة)
- كل دفعة تُسجّل في Audit Log:
  - PAYMENT_CREATE (+ قبل/بعد حالة الفاتورة)

---

## 10) الذمم / المبالغ المؤجلة (Deferred Receivables)

### عمليات مسموحة للمدير

- عرض إجمالي الذمم المؤجلة على مستوى العيادة
- عرض الذمم حسب:
  - مريض
  - طبيب
  - فترة زمنية
- متابعة المتبقي لكل فاتورة

### قواعد

- الذمم المؤجلة **ليست إيراداً محصلاً**
- تُعرض منفصلة وتدخل فقط عند التحصيل

---

## 11) المخزون (Inventory)

### 11.1 عمليات مسموحة للمدير

- إدارة أصناف المخزون (إنشاء/تعديل/تفعيل-تعطيل)
- تسجيل حركات:
  - IN (شراء) — مع تكلفة الوحدة
  - OUT (استهلاك) — بدون أثر مالي مباشر (حسب قرار النظام)
  - ADJUST (تصحيح جرد) — حسب السياسة
- عرض رصيد كل مادة
- عرض تاريخ الحركات
- عرض تنبيهات نقص المخزون (Low Stock)

### 11.2 قواعد وقيود

- IN يجب أن يملك:
  - quantity > 0
  - unit_cost_syp > 0
- OUT لا يسمح أن يجعل المخزون سالباً
- **المشتريات (IN) تُسجّل كمصروف على العيادة فوراً** (Expense at purchase time)

---

## 12) الأرباح وحصة الطبيب (Profit & Dentist Earnings)

> يعتمد على “الكاش المحصَّل” فقط (Cash Basis).

### 12.1 عمليات مسموحة للمدير

- عرض:
  - الإيراد المحصّل (Collected Revenue)
  - المصاريف (خصوصاً مصروفات المخزون)
  - الربح الصافي للعيادة (Net Profit)
- عرض ملخص أرباح كل طبيب (حسب النسبة المعتمدة)
- ضبط/تعديل نسب الأطباء ضمن القيود

### 12.2 قواعد وقيود

- إذا كان NetProfit <= 0:
  - أرباح الأطباء = 0
- لا أرباح سالبة
- لا ترحيل أرباح أو خسائر بين الفترات إلا إذا تم اعتماد ذلك لاحقاً في SSOT
- الطبيب يرى **ملخص أرباحه فقط** (قرارك)

---

## 13) التقارير (Reports) + التصدير (Export)

### عمليات مسموحة للمدير

- الوصول لكل التقارير التشغيلية والمالية
- التصفية حسب:
  - فترة زمنية
  - طبيب
  - مريض
  - خدمة
  - حالات المواعيد
- تصدير التقارير (CSV / PDF إذا معتمد)

### قواعد وقيود

- كل تصدير مالي يجب أن يُسجَّل في Audit Log:
  - REPORT_EXPORT
- منع أي تقرير يؤدي لتسريب بيانات خارج الصلاحيات (RBAC)

---

## 14) سجل التدقيق (Audit Logs)

### عمليات مسموحة للمدير

- عرض كامل سجل التدقيق
- فلترة حسب:
  - تاريخ
  - مستخدم
  - نوع العملية
  - الكيان (Entity)

### قواعد

- السجل Append-only
- لا حذف ولا تعديل

---

## 15) إعدادات النظام (System Settings)

### عمليات مسموحة للمدير

- إعدادات العيادة (عيادة واحدة):
  - بيانات عامة
  - توقيت العيادة
  - تنسيقات التاريخ/الوقت
- إدارة إعدادات أمنية عامة (ضمن ما يسمح به النظام)
- (إن كانت موجودة) إعدادات نسب الأطباء والحدود

---

## 16) ملخص تنفيذي (Executive Summary)

**المدير**:

- يملك صلاحيات تشغيلية ومالية كاملة على مستوى العيادة
- لا يستطيع كسر قواعد:
  - عدم الحذف النهائي
  - عدم تعديل سجلات المال بعد إنشائها
  - منع Overpayment
  - منع مخزون سلبي
  - تسجيل كل العمليات الحساسة في Audit Log
- **الطبيب يملك صلاحية تغيير حالة الموعد كقاعدة نهائية**، بينما المدير يملك صلاحية إشرافية عند الحاجة دون سحب صلاحيات الطبيب.

---

## END OF MANAGER PERMISSIONS DOCUMENT

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  MANAGER
  DENTIST
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum CancellationReason {
  NO_SHOW
  PATIENT_CANCELLED
  CLINIC_CANCELLED
}

enum InvoiceStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

enum InventoryMovementType {
  IN
  OUT
}

enum InventoryTransactionStatus {
  ACTIVE
  VOIDED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
}

enum PaymentStatus {
  ACTIVE
  VOIDED
}

enum DiscountType {
  NONE
  PERCENT
  FIXED
}

model User {
  id        String   @id @default(uuid())
  role      UserRole
  fullName  String   @map("full_name")
  email     String   @unique
  password  String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dentistProfitShare DentistProfitShare?
  appointments       Appointment[]
  visits             Visit[]
  paymentsCreated    Payment[]
  inventoryMovements InventoryMovement[]
  auditLogs          AuditLog[]

  @@map("users")
}

model DentistProfitShare {
  id         String   @id @default(uuid())
  dentistId  String   @unique @map("dentist_id")
  percentage Decimal
  createdAt  DateTime @default(now()) @map("created_at")

  dentist User @relation(fields: [dentistId], references: [id], onDelete: Cascade)

  @@map("dentist_profit_shares")
}

enum Gender {
  MALE
  FEMALE
  UNSPECIFIED
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  UNSPECIFIED
}

model Patient {
  id            String         @id @default(uuid())
  fullName      String         @map("full_name")
  phone         String
  gender        Gender         @default(UNSPECIFIED)
  maritalStatus MaritalStatus  @default(UNSPECIFIED) @map("marital_status")
  dateOfBirth   DateTime?      @map("date_of_birth")
  notes         String?
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")

  appointments Appointment[]
  visits       Visit[]
  invoices     Invoice[]

  @@map("patients")
}

model MedicalCase {
  id           String   @id @default(uuid())
  name         String   @unique
  nameAr       String?  @map("name_ar")
  defaultPrice Decimal  @map("default_price")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  appointments Appointment[]
  visits       Visit[]

  @@map("medical_cases")
}

model Appointment {
  id                 String             @id @default(uuid())
  patientId          String             @map("patient_id")
  dentistId          String             @map("dentist_id")
  medicalCaseId      String             @map("medical_case_id")
  startTime          DateTime           @map("start_time")
  endTime            DateTime           @map("end_time")
  basePriceSyp       Decimal            @map("base_price_syp")
  status             AppointmentStatus  @default(SCHEDULED)
  cancellationReason CancellationReason? @map("cancellation_reason")
  notes              String?
  createdAt          DateTime           @default(now()) @map("created_at")

  patient     Patient     @relation(fields: [patientId], references: [id], onDelete: Restrict)
  dentist     User        @relation(fields: [dentistId], references: [id], onDelete: Restrict)
  medicalCase MedicalCase @relation(fields: [medicalCaseId], references: [id], onDelete: Restrict)
  visit       Visit?

  @@map("appointments")
}

model Visit {
  id            String       @id @default(uuid())
  appointmentId String       @unique @map("appointment_id")
  patientId     String       @map("patient_id")
  dentistId     String       @map("dentist_id")
  medicalCaseId String       @map("medical_case_id")
  basePriceSyp  Decimal      @map("base_price_syp")
  discountType  DiscountType @default(NONE) @map("discount_type")
  discountValue Decimal      @default(0) @map("discount_value")
  finalPriceSyp Decimal      @map("final_price_syp")
  notes         String?
  createdAt     DateTime     @default(now()) @map("created_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Restrict)
  patient     Patient     @relation(fields: [patientId], references: [id], onDelete: Restrict)
  dentist     User        @relation(fields: [dentistId], references: [id], onDelete: Restrict)
  medicalCase MedicalCase @relation(fields: [medicalCaseId], references: [id], onDelete: Restrict)
  invoice     Invoice?

  @@map("visits")
}

model Invoice {
  id             String        @id @default(uuid())
  patientId      String        @map("patient_id")
  visitId        String        @unique @map("visit_id")
  totalAmountSyp Decimal       @map("total_amount_syp")
  paidAmountSyp  Decimal       @default(0) @map("paid_amount_syp")
  status         InvoiceStatus @default(UNPAID)
  createdAt      DateTime      @default(now()) @map("created_at")

  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Restrict)
  visit    Visit     @relation(fields: [visitId], references: [id], onDelete: Restrict)
  payments Payment[]

  @@map("invoices")
}

model Payment {
  id          String        @id @default(uuid())
  invoiceId   String        @map("invoice_id")
  amountSyp   Decimal       @map("amount_syp")
  method      PaymentMethod @default(CASH)
  paymentDate DateTime      @map("payment_date")
  status      PaymentStatus @default(ACTIVE)
  voidReason  String?       @map("void_reason")
  voidedAt    DateTime?     @map("voided_at")
  createdBy   String        @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  creator User    @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  @@map("payments")
}

model InventoryItem {
  id           String   @id @default(uuid())
  name         String   @unique
  nameAr       String?  @map("name_ar")
  quantity     Int      @default(0)
  reorderLevel Int      @map("reorder_level")
  unitPrice    Decimal  @map("unit_price")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  movements InventoryMovement[]

  @@map("inventory_items")
}

model InventoryMovement {
  id           String                     @id @default(uuid())
  itemId       String                     @map("item_id")
  type         InventoryMovementType
  quantity     Int
  unitCostSyp  Decimal?                   @map("unit_cost_syp")
  totalCostSyp Decimal?                   @map("total_cost_syp")
  status       InventoryTransactionStatus @default(ACTIVE)
  voidReason   String?                    @map("void_reason")
  reason       String?
  createdBy    String                     @map("created_by")
  createdAt    DateTime                   @default(now()) @map("created_at")

  item    InventoryItem @relation(fields: [itemId], references: [id], onDelete: Restrict)
  creator User          @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  @@map("inventory_movements")
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String   @map("actor_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  beforeData Json?    @map("before_data")
  afterData  Json?    @map("after_data")
  createdAt  DateTime @default(now()) @map("created_at")

  actor User @relation(fields: [actorId], references: [id], onDelete: Restrict)

  @@map("audit_logs")
}
